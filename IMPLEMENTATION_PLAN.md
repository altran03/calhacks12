# 🎯 IMPLEMENTATION PLAN
## Complete Agent Orchestration & Visualization

---

## ✅ **COMPLETED:**

### **Documentation:**
1. ✅ `CORRECT_AGENT_WORKFLOW.md` - Complete workflow with all phases
2. ✅ `hospital_pharmacy_inventory.json` - Hardcoded medication database (20 common meds)
3. ✅ `YOUR_SETUP_CHECKLIST.md` - What you need to set up

### **Workflow Understanding:**
```
📄 Parser → 🎯 Coordinator → 💊 Pharmacy + 👥 Social Worker
                                    ↓
                            👥 Social Worker triggers:
                            🎫 Eligibility + 📦 Resource + 🏠 Shelter
                                    ↓
                            🏠 Shelter → 🚐 Transport → 🗺️ MapBox
                                    ↓
                            👥 Social Worker (verification)
                                    ↓
                            📄 LaTeX PDF Report
```

---

## 🚧 **PENDING IMPLEMENTATION:**

### **1. Agent Message Models** (30 min)
Create new message models in `agents/models.py`:
- `HospitalPharmacyCheck`
- `PharmacyInventoryResponse`
- `SocialWorkerApproval`
- `ResourceAddressRequest`
- `ShelterAddressResponse`
- `ShelterAvailabilityData` (with coordinates for MapBox)
- `MapBoxVisualizationTrigger`
- `FinalReportData`

### **2. Update Pharmacy Agent** (20 min)
- Load `hospital_pharmacy_inventory.json`
- Check medications against inventory
- Return status with 30-day supply details

### **3. Update Social Worker Agent** (1 hour)
- Review form approval logic
- Trigger Eligibility + Resource + Shelter in parallel
- Collect all agent responses
- **Generate LaTeX PDF report**
- Verification logic

### **4. Update Shelter Agent** (45 min)
- VAPI integration (or mock)
- Return shelter data with **coordinates for MapBox**
- Send address to Resource Agent
- Trigger Transport Agent
- **Send available shelters list to frontend** (for map pins)

### **5. Update Transport Agent** (30 min)
- Schedule ride logic
- Calculate route (use MapBox Directions API)
- **Trigger MapBox visualization** via SSE
- Return tracking data

### **6. Update Resource Agent** (20 min)
- Wait for shelter address
- Coordinate delivery

### **7. Update Eligibility Agent** (20 min)
- Check benefits (can use mock logic for demo)

### **8. Update Coordinator Agent** (30 min)
- Trigger Pharmacy + Social Worker in parallel
- Remove placeholder logic from `main.py`

### **9. Update Analytics Agent** (15 min)
- Monitor all WorkflowUpdate messages
- Log to console/database

---

## 🎨 **FRONTEND IMPLEMENTATION:**

### **1. MapBox Component** (2-3 hours)
Location: `frontend/src/components/MapView.tsx`

**Features:**
```typescript
interface MapViewProps {
  availableShelters: Shelter[];     // From Shelter Agent
  selectedShelter: Shelter;         // Green pin
  pickupLocation: Location;         // Hospital
  route?: Route;                    // From Transport Agent
  vehiclePosition?: VehicleTracking; // Real-time updates
  eta?: number;                     // Minutes remaining
}
```

**Layers:**
1. **Shelters Layer** (Phase 1):
   - Yellow pins for available shelters
   - Green pin for selected shelter
   - Popup on click with shelter details
   
2. **Route Layer** (Phase 2):
   - Animated blue line from hospital to shelter
   - Hospital pin (red)
   - Shelter pin (green)
   
3. **Vehicle Tracking** (Phase 3):
   - Moving car icon
   - ETA countdown
   - Updates every 10 seconds via SSE

**Implementation:**
```tsx
import mapboxgl from 'mapbox-gl';
import MapboxDirections from '@mapbox/mapbox-gl-directions';

export function MapView({ availableShelters, selectedShelter, route }: MapViewProps) {
  // Initialize map
  // Add shelter markers
  // Add route layer
  // Animate vehicle position
  // Update ETA
}
```

### **2. LaTeX PDF Viewer** (30 min)
Location: `frontend/src/components/FinalReport.tsx`

Display the PDF generated by Social Worker Agent:
```tsx
<iframe 
  src={pdfUrl} 
  width="100%" 
  height="800px"
  title="Discharge Coordination Report"
/>
```

### **3. Update WorkflowTimeline** (1 hour)
Add handling for new SSE events:
- `shelter_map_update` - Display shelter pins
- `route_update` - Show route animation
- `vehicle_tracking` - Update vehicle position
- `final_report_ready` - Display LaTeX PDF

---

## 🔧 **BACKEND IMPLEMENTATION:**

### **1. LaTeX Report Template** (1 hour)
Location: `backend/templates/discharge_report.tex`

```latex
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\geometry{margin=1in}
\usepackage{tabularx}
\usepackage{enumitem}

\begin{document}

\title{\textbf{Discharge Coordination Report}}
\author{UCSF Medical Center}
\date{\today}
\maketitle

\section{Patient Information}
Name: {{patient_name}} \\
Case ID: {{case_id}} \\
Discharge Date: {{discharge_date}}

\section{Shelter Placement}
{{shelter_details}}

\section{Transportation}
{{transport_details}}

\section{Medications}
{{medications}}

\section{Resources}
{{resources}}

\section{Benefits Eligibility}
{{benefits}}

\section{Follow-up Care}
{{followup}}

\end{document}
```

### **2. LaTeX Generator Function** (30 min)
Location: `backend/agents/social_worker_agent.py`

```python
from pylatex import Document, Section, Subsection, Command
from pylatex.utils import NoEscape

def generate_latex_report(agent_responses):
    doc = Document()
    # Add sections
    # Populate with agent data
    # Generate PDF
    return pdf_path
```

### **3. Update main.py** (1 hour)
- Remove placeholder `coordinate_agents_realtime`
- Call real Coordinator Agent
- Stream updates from agents via SSE
- Handle MapBox visualization triggers
- Return LaTeX PDF

### **4. SSE Event Updates** (30 min)
Add new SSE event types:
```python
# Shelter map update
await add_timeline_event(case_id, {
    'type': 'shelter_map_update',
    'shelters': available_shelters_with_coordinates
})

# Route visualization
await add_timeline_event(case_id, {
    'type': 'route_update',
    'pickup': pickup_location,
    'dropoff': shelter_location,
    'route': route_polyline
})

# Vehicle tracking
await add_timeline_event(case_id, {
    'type': 'vehicle_tracking',
    'position': current_position,
    'eta_minutes': eta
})

# Final report
await add_timeline_event(case_id, {
    'type': 'final_report_ready',
    'pdf_url': report_pdf_url
})
```

---

## 📊 **DATA FILES TO CREATE:**

### **1. Shelter Database** (if mocking)
`backend/data/sf_shelters.json`:
```json
{
  "shelters": [
    {
      "name": "Harbor Light Center",
      "address": "123 Main St, San Francisco, CA",
      "coordinates": [37.7749, -122.4194],
      "phone": "(415) 555-0100",
      "capacity": 100,
      "available_beds": 12,
      "wheelchair_accessible": true,
      "services": ["meals", "showers", "case_management", "medical_respite"],
      "dietary_accommodations": true,
      "hours": "24/7"
    },
    // ... more shelters
  ]
}
```

### **2. Resource Providers** (if mocking)
`backend/data/sf_resources.json`:
```json
{
  "food_providers": [...],
  "hygiene_providers": [...],
  "clothing_providers": [...]
}
```

---

## ⏰ **IMPLEMENTATION TIMELINE:**

### **Day 1: Agent Orchestration** (4-5 hours)
- [ ] Create new message models
- [ ] Update all agents with correct workflow
- [ ] Test agent-to-agent communication
- [ ] Update main.py to use real agents

### **Day 2: MapBox Visualization** (3-4 hours)
- [ ] Set up MapBox component
- [ ] Implement shelter pins layer
- [ ] Implement route visualization
- [ ] Implement vehicle tracking

### **Day 3: LaTeX Reports** (2-3 hours)
- [ ] Create LaTeX template
- [ ] Implement PDF generation
- [ ] Add PDF viewer to frontend
- [ ] Test end-to-end

### **Day 4: Testing & Polish** (2-3 hours)
- [ ] Test full workflow
- [ ] Fix bugs
- [ ] Polish UI
- [ ] Prepare demo

---

## 🚀 **READY TO START?**

**Tell me:**
1. ✅ Real or mocked VAPI calls?
2. ✅ Real or mocked Bright Data?
3. ✅ Do you have MapBox token?
4. ✅ When do you need this done? (Hackathon date?)

**Once you confirm, I'll start implementing immediately!**

---

## 📝 **NOTES:**

- Parser Agent already works ✅
- Hospital pharmacy inventory created ✅
- Workflow fully documented ✅
- All message flow diagrams ready ✅

**Now we just need to build it!** 🔨

